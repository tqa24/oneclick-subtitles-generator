name: Build Electron App

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node-version: [20.x]
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'
        
    - name: Install system dependencies (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          python3-dev \
          python3-pip \
          build-essential \
          curl \
          wget \
          unzip \
          xvfb \
          libgtk-3-dev \
          libnotify-dev \
          libgconf-2-4 \
          libnss3 \
          libasound2 \
          libxtst6 \
          libxss1 \
          libgconf-2-4 \
          libappindicator3-1 \
          libsecret-1-dev \
          libgtk-3-0 \
          libx11-xcb1 \
          libxcb-dri3-0
            
    - name: Install system dependencies (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        brew install python@3.10
        
    - name: Install system dependencies (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        choco install python3 --version 3.10.0
        
    - name: Install Python packages
      run: |
        python -m pip install --upgrade pip
        pip install wheel setuptools
        
    - name: Install Node.js dependencies
      run: npm ci
      
    - name: Install additional build tools
      run: |
        npm install -g node-gyp
        if [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
          sudo npm install -g electron-builder --unsafe-perm=true --allow-root
        else
          npm install -g electron-builder
        fi
        
    - name: Build Python wheelhouse
      run: node scripts/create-python-wheelhouse.js
      env:
        PYTHON_PATH: python
        
    - name: Bundle platform binaries
      run: node scripts/bundle-binaries.js
      
    - name: Build React frontend
      run: npm run build
      
    - name: Build Electron app (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        npm run dist:linux
        npm run pack:linux
        
    - name: Build Electron app (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        # Sign the app if available (add your certificate logic here)
        npm run dist:mac
        
    - name: Build Electron app (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        # Sign the app if available (add your certificate logic here)
        npm run dist:win
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: electron-build-${{ matrix.os }}
        path: |
          electron-dist/
          !electron-dist/*.deb
          !electron-dist/*.rpm
          !electron-dist/*.AppImage
          !electron-dist/*.dmg
          retention-days: 30
        
    - name: Upload Linux specific artifacts
      if: matrix.os == 'ubuntu-latest'
      uses: actions/upload-artifact@v4
      with:
        name: electron-linux
        path: |
          electron-dist/*.AppImage
          electron-dist/*.deb
          retention-days: 30
        
    - name: Upload macOS specific artifacts
      if: matrix.os == 'macos-latest'
      uses: actions/upload-artifact@v4
      with:
        name: electron-macos
        path: |
          electron-dist/*.dmg
          electron-dist/*.zip
        retention-days: 30
        
    - name: Upload Windows specific artifacts
      if: matrix.os == 'windows-latest'
      uses: actions/upload-artifact@v4
      with:
        name: electron-windows
        path: |
          electron-dist/*.exe
          electron-dist/*.nsis.*
        retention-days: 30

  test:
    needs: build
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download Linux artifacts
      uses: actions/download-artifact@v4
      with:
        name: electron-linux
        path: artifacts-linux/
        
    - name: Test Linux build
      run: |
        # Install AppImage dependencies and test
        sudo apt-get update
        sudo apt-get install -y fuse
        chmod +x artifacts-linux/*.AppImage
        echo "AppImage permissions set successfully"
        
    - name: Test Windows build in Wine
      run: |
        # Install Wine for testing Windows builds on Linux
        sudo dpkg --add-architecture i386
        sudo apt-get update
        sudo apt-get install -y wine
        
    - name: Test macOS build
      run: |
        echo "macOS build test would require macOS environment"
        
  release:
    needs: [build, test]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      
    - name: Create release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          electron-windows/*
          electron-macos/*
          electron-linux/*
        generate_release_notes: true
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Update release with checksums
      run: |
        # Generate checksums for all artifacts
        cd electron-windows
        sha256sum *.exe *.nsis.* > checksums.txt
        cd ../electron-macos
        sha256sum *.dmg *.zip > checksums.txt
        cd ../electron-linux
        sha256sum *.AppImage *.deb > checksums.txt
        
    - name: Upload checksums
      uses: softprops/action-gh-release@v1
      with:
        files: |
          */*/checksums.txt
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}